// =============================================================================
// Prisma schema for Georgia Biology Progress Monitoring Tool
// Enhanced with comprehensive role hierarchy and organizational structure
// =============================================================================

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// -----------------------------------------------------------------------------
// Enums
// -----------------------------------------------------------------------------

enum UserRole {
  // System-wide administration
  SUPER_ADMIN      // Top-level: system-wide access, all capabilities

  // Administrative roles (report to SUPER_ADMIN)
  DISTRICT_ADMIN   // Multi-school analytics and management
  DATA_STEWARD     // Privacy, compliance, data governance
  TECH_ADMIN       // Integrations, technical configuration

  // School-level management
  SCHOOL_ADMIN     // School-wide access, all teachers, interventions
  DEPT_CHAIR       // Department analytics, collaboration

  // Educational roles
  TEACHER          // Own classes, own students, assessments

  // End users
  STUDENT          // View own data only
  PARENT           // Limited view of child's data
}

enum Capability {
  // Analytics and data access
  MULTI_SITE_ANALYTICS      // Access data across multiple schools/sites
  SCHOOL_WIDE_DATA          // Access all data within a school
  DEPARTMENT_DATA           // Access department-level aggregated data
  CLASS_LEVEL_DATA          // Access class-level data
  INDIVIDUAL_STUDENT_DATA   // Access individual student records

  // Educational operations
  CREATE_ASSESSMENTS        // Create and manage assessments
  VIEW_PREDICTIONS          // View ML/predictive analytics

  // System administration
  SYSTEM_CONFIGURATION      // Modify system settings and configuration
  MANAGE_USERS              // Create, update, delete user accounts
  MANAGE_INTEGRATIONS       // Configure external system integrations
  PRIVACY_COMPLIANCE        // Access to privacy and compliance tools
}

enum AccessLevel {
  FULL      // Complete access
  LIMITED   // Restricted/filtered access
  NONE      // No access
}

// -----------------------------------------------------------------------------
// Organizational Hierarchy Models
// -----------------------------------------------------------------------------

model District {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  state       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  schools     School[]
  users       User[]
}

model School {
  id          String   @id @default(cuid())
  name        String
  code        String   @unique
  districtId  String?
  address     String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  district    District?    @relation(fields: [districtId], references: [id])
  departments Department[]
  classrooms  Classroom[]
  users       User[]

  @@index([districtId])
}

model Department {
  id          String   @id @default(cuid())
  name        String   // e.g., "Science", "Biology", "Mathematics"
  code        String
  schoolId    String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  school      School      @relation(fields: [schoolId], references: [id])
  classrooms  Classroom[]
  users       User[]      // Department chairs and teachers

  @@unique([schoolId, code])
  @@index([schoolId])
}

// -----------------------------------------------------------------------------
// User and Authentication Models
// -----------------------------------------------------------------------------

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  role         UserRole @default(TEACHER)
  name         String?

  // Organizational associations
  districtId   String?
  schoolId     String?
  departmentId String?

  // Additional metadata
  isActive     Boolean  @default(true)
  lastLoginAt  DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relationships
  district     District?    @relation(fields: [districtId], references: [id])
  school       School?      @relation(fields: [schoolId], references: [id])
  department   Department?  @relation(fields: [departmentId], references: [id])

  // A teacher can own many classrooms
  classrooms   Classroom[]  @relation("TeacherClassrooms")

  // Parent-student relationships
  children     StudentParent[] @relation("ParentUser")

  // Student profile (if role is STUDENT)
  studentProfile Student?   @relation("StudentUser")

  @@index([email])
  @@index([role])
  @@index([districtId])
  @@index([schoolId])
  @@index([departmentId])
}

// -----------------------------------------------------------------------------
// Educational Models
// -----------------------------------------------------------------------------

// A teacher-owned class/section (e.g., "1st Period Biology")
model Classroom {
  id           String      @id @default(cuid())
  name         String
  code         String?     // Class code for enrollment
  schoolId     String?
  departmentId String?
  ownerId      String

  // Class metadata
  academicYear String?     // e.g., "2024-2025"
  semester     String?     // e.g., "Fall", "Spring"
  gradeLevel   String?     // e.g., "9", "10", "11", "12"

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  school       School?      @relation(fields: [schoolId], references: [id])
  department   Department?  @relation(fields: [departmentId], references: [id])
  owner        User         @relation("TeacherClassrooms", fields: [ownerId], references: [id])
  enrollments  Enrollment[]

  @@index([ownerId])
  @@index([schoolId])
  @@index([departmentId])
}

// Student entities
model Student {
  id           String       @id @default(cuid())
  firstName    String
  lastName     String
  studentCode  String       @unique  // SIS ID or teacher-defined code

  // Link to user account (if student has login access)
  userId       String?      @unique

  // Student metadata
  gradeLevel   String?
  dateOfBirth  DateTime?
  notes        String?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User?            @relation("StudentUser", fields: [userId], references: [id])
  enrollments  Enrollment[]
  parents      StudentParent[]

  @@index([studentCode])
  @@index([userId])
}

// Join table linking students to classrooms
model Enrollment {
  id          String    @id @default(cuid())
  studentId   String
  classroomId String

  // Enrollment metadata
  status      String    @default("active")  // active, withdrawn, completed
  enrolledAt  DateTime  @default(now())

  createdAt   DateTime  @default(now())

  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  classroom   Classroom @relation(fields: [classroomId], references: [id], onDelete: Cascade)

  @@unique([studentId, classroomId])
  @@index([classroomId])
  @@index([studentId])
}

// Parent-student relationship
model StudentParent {
  id          String    @id @default(cuid())
  studentId   String
  parentId    String    // User ID of parent

  relationship String?  // e.g., "mother", "father", "guardian"
  isPrimary   Boolean   @default(false)

  createdAt   DateTime  @default(now())

  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  parent      User      @relation("ParentUser", fields: [parentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([studentId])
  @@index([parentId])
}
